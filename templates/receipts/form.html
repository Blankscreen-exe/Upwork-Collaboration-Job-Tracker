{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Edit Receipt</h1>

<form method="POST" action="/receipts/{{ receipt.id }}/edit">
    <div class="mb-3">
        <label for="received_date" class="form-label">Received Date *</label>
        <input type="date" class="form-control" id="received_date" name="received_date" value="{{ receipt.received_date }}" required>
    </div>
    <div class="mb-3">
        <label for="amount_received" class="form-label">Amount *</label>
        <input type="number" step="0.01" class="form-control" id="amount_received" name="amount_received" value="{{ receipt.amount_received }}" required>
    </div>
    <div class="mb-3">
        <label for="source" class="form-label">Source *</label>
        <select class="form-select" id="source" name="source" required>
            <option value="milestone" {% if receipt.source.value == "milestone" %}selected{% endif %}>Milestone</option>
            <option value="weekly" {% if receipt.source.value == "weekly" %}selected{% endif %}>Weekly</option>
            <option value="bonus" {% if receipt.source.value == "bonus" %}selected{% endif %}>Bonus</option>
            <option value="manual" {% if receipt.source.value == "manual" %}selected{% endif %}>Manual</option>
        </select>
    </div>
    
    <!-- Allocation Selection -->
    {% if allocations %}
    <div class="mb-3">
        <label class="form-label">Allocate to Workers</label>
        <div class="form-text mb-2">Select which workers should receive money from this receipt. If none selected, all workers will receive based on their allocation percentages.</div>
        <div class="border rounded p-3">
            {% for alloc in allocations %}
                {% if alloc.worker_id %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           name="selected_allocations" 
                           value="{{ alloc.id }}" 
                           id="alloc_{{ alloc.id }}"
                           {% if selected_allocation_ids|length == 0 %}checked{% elif alloc.id in selected_allocation_ids %}checked{% endif %}>
                    <label class="form-check-label" for="alloc_{{ alloc.id }}">
                        <strong>{{ alloc.label }}</strong>
                        {% if alloc.worker %}
                            ({{ alloc.worker.name }} - {{ alloc.worker.worker_code }})
                        {% endif %}
                        - 
                        {% if alloc.share_type == "percent" %}
                            {{ (alloc.share_value * 100)|round(1) }}%
                        {% else %}
                            ${{ "%.2f"|format(alloc.share_value) }}
                        {% endif %}
                    </label>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="mb-3">
        <label for="upwork_transaction_id" class="form-label">Upwork Transaction ID</label>
        <input type="text" class="form-control" id="upwork_transaction_id" name="upwork_transaction_id" value="{{ receipt.upwork_transaction_id or '' }}">
    </div>
    <div class="mb-3">
        <label for="notes" class="form-label">Notes</label>
        <textarea class="form-control" id="notes" name="notes" rows="3">{{ receipt.notes or '' }}</textarea>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
    <a href="/jobs/{{ receipt.job_id }}" class="btn btn-secondary">Cancel</a>
</form>
{% endblock %}
