{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Dashboard</h1>

<!-- TOP SECTION: Original Dashboard Content -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Received</h5>
                <h3 class="text-success">${{ "%.2f"|format(totals.total_received) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Connects</h5>
                <h3 class="text-warning">${{ "%.2f"|format(totals.total_connects) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Platform Fee</h5>
                <h3 class="text-info">${{ "%.2f"|format(totals.total_platform_fee) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Paid</h5>
                <h3 class="text-primary">${{ "%.2f"|format(totals.total_paid) }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Due</h5>
                <h2 class="text-danger">${{ "%.2f"|format(totals.total_due) }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Top Due Workers</h5>
            </div>
            <div class="card-body">
                {% if worker_dues %}
                <table class="table data-table">
                    <thead>
                        <tr>
                            <th>Worker</th>
                            <th>Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in worker_dues %}
                        <tr>
                            <td><a href="/workers/{{ item.worker.id }}">{{ item.worker.name }}</a></td>
                            <td class="text-danger">${{ "%.2f"|format(item.due) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">No workers with outstanding dues.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Recent Jobs</h5>
            </div>
            <div class="card-body">
                {% if recent_jobs %}
                <table class="table data-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Title</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in recent_jobs %}
                        <tr>
                            <td>{{ job.job_code }}</td>
                            <td><a href="/jobs/{{ job.id }}">{{ job.title }}</a></td>
                            <td><span class="badge bg-secondary">{{ job.status.value }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">No recent jobs.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- BOTTOM SECTION: Expense Tracking -->
<hr class="my-5">
<h2 class="mb-4">Expense Tracking</h2>

<!-- Date Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Date Range Filter</h5>
        <form method="GET" action="/" class="row g-3">
            <div class="col-md-3">
                <label for="date_from" class="form-label">From Date</label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-3">
                <label for="date_to" class="form-label">To Date</label>
                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
            </div>
            <div class="col-md-6 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary">Apply Filter</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setQuickFilter('this_month')">This Month</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setQuickFilter('last_month')">Last Month</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setQuickFilter('this_year')">This Year</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setQuickFilter('all_time')">All Time</button>
            </div>
        </form>
        <small class="text-muted">Note: Expense and earnings calculations use the date filter. Other totals show all-time data.</small>
    </div>
</div>

<!-- Expense Summary Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Expenses</h5>
                <h3 class="text-danger">${{ "%.2f"|format(expense_totals) }}</h3>
                <small class="text-muted">Current Period</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Earnings</h5>
                <h3 class="text-success">${{ "%.2f"|format(earnings_total) }}</h3>
                <small class="text-muted">Current Period</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">My Earnings</h5>
                <h3 class="text-info">${{ "%.2f"|format(owner_earnings_total) }}</h3>
                <small class="text-muted">Current Period</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Profit</h5>
                <h3 class="{% if profit >= 0 %}text-primary{% else %}text-danger{% endif %}">${{ "%.2f"|format(profit) }}</h3>
                <small class="text-muted">My Earnings - Expenses</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Margin</h5>
                <h3 class="{% if margin >= 0 %}text-success{% else %}text-danger{% endif %}">{{ "%.1f"|format(margin) }}%</h3>
                <small class="text-muted">Profit / My Earnings</small>
            </div>
        </div>
    </div>
</div>

<!-- Chart Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Expenses vs Earnings vs My Earnings</h5>
            </div>
            <div class="card-body">
                <canvas id="expenseChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function setQuickFilter(filter) {
    const today = new Date();
    let fromDate, toDate;
    
    if (filter === 'this_month') {
        fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
        toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    } else if (filter === 'last_month') {
        fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        toDate = new Date(today.getFullYear(), today.getMonth(), 0);
    } else if (filter === 'this_year') {
        fromDate = new Date(today.getFullYear(), 0, 1);
        toDate = new Date(today.getFullYear(), 11, 31);
    } else if (filter === 'all_time') {
        fromDate = null;
        toDate = null;
    }
    
    if (fromDate && toDate) {
        document.getElementById('date_from').value = fromDate.toISOString().split('T')[0];
        document.getElementById('date_to').value = toDate.toISOString().split('T')[0];
    } else {
        document.getElementById('date_from').value = '';
        document.getElementById('date_to').value = '';
    }
    
    // Submit the form
    document.querySelector('form').submit();
}

// Initialize Chart.js
const chartData = {{ chart_data|safe }};
const ctx = document.getElementById('expenseChart').getContext('2d');

new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: [
            {
                label: 'Expenses',
                data: chartData.expenses,
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.1
            },
            {
                label: 'Total Earnings',
                data: chartData.earnings,
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.1
            },
            {
                label: 'My Earnings',
                data: chartData.owner_earnings,
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
